language: java
dist: trusty
sudo: required
group: deprecated-2017Q4

jdk: openjdk8

services:
  - docker

cache:
  directories:
  - .autoconf
  - $HOME/.m2
  - _build
  - deps

before_install:
- echo -e "machine github.com\n  login $GITHUB_TOKEN" >> ~/.netrc
- git lfs pull

install:
- mvn -N io.takari:maven:wrapper
- ./mvnw install -DskipTests=true -Dmaven.javadoc.skip=true -B -V

branches:
  only:
    - dev
    - master
    
stages:
  - deploy test server               #TODO: need to fix
  - test
  - name: push docker test image
    if: branch = dev
  - name: deploy prod and push docker image
    if: branch = master

jobs:
  include:
    - stage: deploy test server
      env:
        - BRANCH_LINUX_CHROME=linux-chrome
        - BRANCH_LINUX_FIREFOX=linux-firefox
      script:
        - git branch ${BRANCH_LINUX_FIREFOX}
        - git push -f origin ${BRANCH_LINUX_FIREFOX}
        - git branch ${BRANCH_LINUX_CHROME}            #TODO: need to fix
        - git push -f origin ${BRANCH_LINUX_CHROME}    #TODO: need to fix
    - stage: test
      os:
        - linux
      env:
        - UNIT=unit-test
      script:
        - mvn test -P ${UNIT}
    - stage: test
      os:
        - linux
      env:
        - API=api-test
      script:
        - mvn test -P ${API}
    - stage: test
      os:
        - linux
      env:
        - SELENIUM_BROWSER=chrome
      script:
        - if [ $SELENIUM_BROWSER == 'chrome' ]; then docker-compose up -d; fi
        - if [ $SELENIUM_BROWSER == 'chrome' ]; then mvn test -P linux-chrome; fi
    - stage: test
      os:
        - linux
      env:
        - SELENIUM_BROWSER=firefox
      script:
        - if [ $SELENIUM_BROWSER == 'firefox' ]; then docker-compose up -d; fi
        - if [ $SELENIUM_BROWSER == 'firefox' ]; then mvn test -P linux-firefox; fi
    - stage: push docker test image
      env:
        - IMAGE=fiodar/td:test
      script:
      - mvn clean package -DskipTests=true
      - mvn docker:build
      - docker login -u $DOCKER_USER -p $DOCKER_PASS
      - docker push ${IMAGE}
    - stage: deploy prod and push docker image
      env:
        - BRANCH_PROD=prod
        - IMAGE=fiodar/td
      script:
      - git branch ${BRANCH_PROD}
      - git push -f origin ${BRANCH_PROD}
      - mvn clean package -DskipTests=true
      - mvn docker:build
      - docker login -u $DOCKER_USER -p $DOCKER_PASS
      - docker push ${IMAGE}   
